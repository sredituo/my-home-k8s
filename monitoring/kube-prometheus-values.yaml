grafana:
  adminPassword: admin

  # Loki ãƒ‡ãƒ¼ã‚¿ã‚½ãƒ¼ã‚¹ã‚’è¿½åŠ 
  additionalDataSources:
    - name: Loki
      type: loki
      url: http://loki.monitoring.svc.cluster.local:3100
      access: proxy
      isDefault: false
      uid: loki

  # ã‚¢ãƒ©ãƒ¼ãƒˆè¨­å®š
  alerting:
    # é€šçŸ¥å…ˆï¼ˆDiscord Webhookï¼‰
    contactpoints.yaml:
      apiVersion: 1
      contactPoints:
        - orgId: 1
          name: discord
          receivers:
            - uid: discord-webhook
              type: discord
              settings:
                url: "https://discord.com/api/webhooks/1469702300028108835/10smB08qpTLl87ggn4t6wlCvYdCpDsdeZjv4_5zs0HqbzQtv8czw3KSplNQfdXDL5tFf"
                use_discord_username: true
                message: |
                  {{ range .Alerts }}
                  **{{ .Labels.alertname }}** ({{ .Status }})
                  {{ .Annotations.summary }}
                  {{ .Annotations.description }}
                  ğŸ“‹ **ãƒ­ã‚°ç¢ºèª**: {{ .Annotations.explore_url }}
                  {{ end }}

    # é€šçŸ¥ãƒãƒªã‚·ãƒ¼ï¼ˆã™ã¹ã¦ã®ã‚¢ãƒ©ãƒ¼ãƒˆã‚’Discordã«é€ã‚‹ï¼‰
    notification-policies.yaml:
      apiVersion: 1
      policies:
        - orgId: 1
          receiver: discord
          group_by:
            - grafana_folder
            - alertname

    # ã‚¢ãƒ©ãƒ¼ãƒˆãƒ«ãƒ¼ãƒ«ï¼ˆta2musicã®WARN/ERRORãƒ­ã‚°æ¤œçŸ¥ï¼‰
    rules.yaml:
      apiVersion: 1
      groups:
        - orgId: 1
          name: ta2music-alerts
          folder: ta2music
          interval: 1m
          rules:
            - uid: ta2music-warn-error
              title: "ta2music WARN/ERROR ãƒ­ã‚°æ¤œå‡º"
              condition: B
              data:
                # A: Lokiã‚¯ã‚¨ãƒª - éå»5åˆ†é–“ã®WARN/ERRORãƒ­ã‚°ä»¶æ•°
                - refId: A
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: loki
                  model:
                    expr: 'count_over_time({namespace="ta2music", container="ta2music"} |~ `(WARNING|ERROR)` [5m])'
                    queryType: range
                # B: é–¾å€¤åˆ¤å®š - 1ä»¶ä»¥ä¸Šã§ã‚¢ãƒ©ãƒ¼ãƒˆç™ºç«
                - refId: B
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: __expr__
                  model:
                    type: reduce
                    expression: A
                    reducer: last
                - refId: C
                  relativeTimeRange:
                    from: 300
                    to: 0
                  datasourceUid: __expr__
                  model:
                    type: threshold
                    expression: B
                    conditions:
                      - evaluator:
                          type: gt
                          params:
                            - 0
              condition: C
              for: 0m
              labels:
                severity: warning
                app: ta2music
              annotations:
                summary: "ta2music ã§ WARN/ERROR ãƒ¬ãƒ™ãƒ«ã®ãƒ­ã‚°ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
                description: "ta2music ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§ WARN ã¾ãŸã¯ ERROR ãƒ¬ãƒ™ãƒ«ã®ãƒ­ã‚°ãŒéå»5åˆ†é–“ã«å‡ºåŠ›ã•ã‚Œã¾ã—ãŸã€‚"
                explore_url: 'http://localhost:3000/explore?schemaVersion=1&panes=%7B%22a%22%3A%7B%22datasource%22%3A%22loki%22%2C%22queries%22%3A%5B%7B%22refId%22%3A%22A%22%2C%22expr%22%3A%22%7Bnamespace%3D%5C%22ta2music%5C%22%2C+container%3D%5C%22ta2music%5C%22%7D+%7C%3D+%60WARNING%60+or+%60ERROR%60%22%7D%5D%2C%22range%22%3A%7B%22from%22%3A%22now-15m%22%2C%22to%22%3A%22now%22%7D%7D%7D'

